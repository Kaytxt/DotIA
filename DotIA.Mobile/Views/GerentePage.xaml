<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:DotIA.Mobile.ViewModels"
             xmlns:models="clr-namespace:DotIA.Mobile.Models"
             x:Class="DotIA.Mobile.Views.GerentePage"
             x:DataType="viewmodels:GerenteViewModel"
             Title="Painel de Gerenciamento"
             BackgroundColor="{StaticResource Background}">

    <ScrollView>
        <VerticalStackLayout Spacing="15" Padding="15">

            <!-- Header -->
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,10" ColumnSpacing="12">
                <Border Grid.Column="0"
                        HeightRequest="40"
                        WidthRequest="40"
                        StrokeThickness="0">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="{StaticResource Primary}" Offset="0.0" />
                            <GradientStop Color="{StaticResource Secondary}" Offset="1.0" />
                        </LinearGradientBrush>
                    </Border.Background>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="20"/>
                    </Border.StrokeShape>
                    <Image Source="dotia_logo.png"
                           Margin="8"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Border>
                <Label Grid.Column="1"
                       Text="{Binding NomeUsuario, StringFormat='Olá, {0}'}"
                       TextColor="White"
                       FontSize="20"
                       FontAttributes="Bold"
                       VerticalOptions="Center"/>
                <Button Grid.Column="2"
                        Text="Sair"
                        Command="{Binding SairCommand}"
                        BackgroundColor="{StaticResource Error}"
                        TextColor="White"/>
            </Grid>

            <!-- Cards de Estatísticas em Grid 2x3 -->
            <HorizontalStackLayout Spacing="8">
                <Image Source="icon_grafico.png" WidthRequest="20" HeightRequest="20" VerticalOptions="Center"/>
                <Label Text="Estatísticas" TextColor="White" FontSize="18" FontAttributes="Bold" VerticalOptions="Center"/>
            </HorizontalStackLayout>

            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="10">
                <!-- Card 1: Total Usuários -->
                <Border Grid.Row="0" Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="{StaticResource BorderColor}"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_pessoa.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TotalUsuarios}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Total Usuários" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 2: Tickets Abertos -->
                <Border Grid.Row="0" Grid.Column="1"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="{StaticResource BorderColor}"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_ticket.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TicketsAbertos}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Tickets Abertos" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 3: Resolvidos -->
                <Border Grid.Row="1" Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="{StaticResource BorderColor}"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_check.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TicketsResolvidos}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Resolvidos" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 4: Total Chats -->
                <Border Grid.Row="1" Grid.Column="1"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="{StaticResource BorderColor}"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_balao.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TotalChats}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Total Chats" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 5: Hoje -->
                <Border Grid.Row="2" Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="{StaticResource BorderColor}"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_grafico.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding ResolvidosHoje}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Hoje" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 6: Concluídos -->
                <Border Grid.Row="2" Grid.Column="1"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="{StaticResource BorderColor}"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_balao.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding ChatsConcluidos}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Concluídos" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <!-- Tabs -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="5" Margin="0,10,0,0">
                <!-- Tab Tickets -->
                <Border Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>
                    <Border.Triggers>
                        <DataTrigger TargetType="Border" Binding="{Binding AbaAtiva}" Value="0">
                            <Setter Property="Background">
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="{StaticResource Primary}" Offset="0.0" />
                                    <GradientStop Color="{StaticResource Secondary}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Setter>
                        </DataTrigger>
                    </Border.Triggers>
                    <Button Text="Tickets"
                            Command="{Binding MudarAbaCommand}"
                            CommandParameter="Tickets"
                            BackgroundColor="Transparent"
                            TextColor="White"/>
                </Border>

                <!-- Tab Usuários -->
                <Border Grid.Column="1"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>
                    <Border.Triggers>
                        <DataTrigger TargetType="Border" Binding="{Binding AbaAtiva}" Value="1">
                            <Setter Property="Background">
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="{StaticResource Primary}" Offset="0.0" />
                                    <GradientStop Color="{StaticResource Secondary}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Setter>
                        </DataTrigger>
                    </Border.Triggers>
                    <Button Text="Usuários"
                            Command="{Binding MudarAbaCommand}"
                            CommandParameter="Usuarios"
                            BackgroundColor="Transparent"
                            TextColor="White"/>
                </Border>

                <!-- Tab Relatórios -->
                <Border Grid.Column="2"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>
                    <Border.Triggers>
                        <DataTrigger TargetType="Border" Binding="{Binding AbaAtiva}" Value="2">
                            <Setter Property="Background">
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="{StaticResource Primary}" Offset="0.0" />
                                    <GradientStop Color="{StaticResource Secondary}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Setter>
                        </DataTrigger>
                    </Border.Triggers>
                    <Button Text="Relatórios"
                            Command="{Binding MudarAbaCommand}"
                            CommandParameter="Relatorios"
                            BackgroundColor="Transparent"
                            TextColor="White"/>
                </Border>
            </Grid>

            <!-- ABA TICKETS -->
            <VerticalStackLayout IsVisible="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=0}" Spacing="5">
                <HorizontalStackLayout Spacing="8" Margin="0,10,0,5">
                    <Image Source="icon_ticket.png" WidthRequest="18" HeightRequest="18" VerticalOptions="Center"/>
                    <Label Text="Tickets" TextColor="White" FontSize="16" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>

                <Label Text="{Binding Tickets.Count, StringFormat='Total: {0} tickets'}" TextColor="{StaticResource TextTertiary}" FontSize="12"/>

                <CollectionView ItemsSource="{Binding Tickets}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:TicketGerenteDTO">
                            <Border BackgroundColor="{StaticResource BackgroundLight}"
                                    Padding="10"
                                    Margin="0,0,0,5"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding Id, StringFormat='ID: {0}'}" TextColor="{StaticResource Info}" FontSize="12" FontAttributes="Bold"/>
                                    <Label Text="{Binding NomeSolicitante, StringFormat='Solicitante: {0}'}" TextColor="White" FontSize="13"/>
                                    <Label Text="{Binding Departamento, StringFormat='Depto: {0}'}" TextColor="{StaticResource TextTertiary}" FontSize="11"/>
                                    <Label Text="{Binding DescricaoProblema}" TextColor="{StaticResource TextSecondary}" FontSize="12" MaxLines="2"/>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Grid.Column="0" Text="{Binding DataAbertura, StringFormat='{0:dd/MM/yy HH:mm}'}" TextColor="{StaticResource TextMuted}" FontSize="10"/>
                                        <Label Grid.Column="1" Text="{Binding Status}" TextColor="{StaticResource Success}" FontSize="10"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- ABA USUÁRIOS -->
            <VerticalStackLayout IsVisible="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=1}" Spacing="5">
                <HorizontalStackLayout Spacing="8" Margin="0,10,0,5">
                    <Image Source="icon_pessoa.png" WidthRequest="18" HeightRequest="18" VerticalOptions="Center"/>
                    <Label Text="Usuários" TextColor="White" FontSize="16" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>

                <Label Text="{Binding Usuarios.Count, StringFormat='Total: {0} usuários'}" TextColor="{StaticResource TextTertiary}" FontSize="12"/>

                <CollectionView ItemsSource="{Binding Usuarios}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:UsuarioGerenteDTO">
                            <Border BackgroundColor="{StaticResource BackgroundLight}"
                                    Padding="10"
                                    Margin="0,0,0,5"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0">
                                <VerticalStackLayout Spacing="5">
                                    <Label Text="{Binding Nome}" TextColor="White" FontSize="14" FontAttributes="Bold"/>
                                    <Label Text="{Binding Email}" TextColor="{StaticResource TextTertiary}" FontSize="12"/>
                                    <Label Text="{Binding Departamento, StringFormat='Depto: {0}'}" TextColor="{StaticResource Info}" FontSize="11"/>
                                    <Label TextColor="{StaticResource TextTertiary}" FontSize="10">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Tickets: "/>
                                                <Span Text="{Binding TotalTickets}"/>
                                                <Span Text=" | Abertos: "/>
                                                <Span Text="{Binding TicketsAbertos}"/>
                                                <Span Text=" | Chats: "/>
                                                <Span Text="{Binding TotalChats}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <!-- Botões de Ação -->
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="5" RowSpacing="5" Margin="0,5,0,0">
                                        <Button Grid.Row="0" Grid.Column="0" Text="Editar" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=EditarUsuarioCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="{StaticResource Info}"/>
                                        <Button Grid.Row="0" Grid.Column="1" Text="Cargo" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=AlterarCargoCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="{StaticResource Secondary}"/>
                                        <Button Grid.Row="1" Grid.Column="0" Text="Senha" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=AlterarSenhaCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="{StaticResource Warning}"/>
                                        <Button Grid.Row="1" Grid.Column="1" Text="Ver Tickets" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=VerTicketsUsuarioCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="{StaticResource Success}"/>
                                        <Button Grid.Row="2" Grid.ColumnSpan="2" Text="Excluir Usuário" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=ExcluirUsuarioCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="{StaticResource Error}"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- ABA RELATÓRIOS -->
            <VerticalStackLayout IsVisible="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=2}" Spacing="10">
                <HorizontalStackLayout Spacing="8" Margin="0,10,0,5">
                    <Image Source="icon_grafico.png" WidthRequest="18" HeightRequest="18" VerticalOptions="Center"/>
                    <Label Text="Relatórios" TextColor="White" FontSize="16" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>

                <!-- Por Departamento -->
                <Label Text="Por Departamento" TextColor="White" FontSize="14" FontAttributes="Bold"/>
                <Label Text="{Binding RelatoriosDepartamentos.Count, StringFormat='Total: {0} departamentos'}" TextColor="{StaticResource TextTertiary}" FontSize="12"/>

                <CollectionView ItemsSource="{Binding RelatoriosDepartamentos}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:RelatorioDepartamentoDTO">
                            <Border BackgroundColor="{StaticResource BackgroundLight}"
                                    Padding="10"
                                    Margin="0,0,0,5"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding Departamento}" TextColor="White" FontSize="13" FontAttributes="Bold"/>
                                    <Label TextColor="{StaticResource TextTertiary}" FontSize="11">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Usuários: "/>
                                                <Span Text="{Binding TotalUsuarios}"/>
                                                <Span Text=" | Tickets: "/>
                                                <Span Text="{Binding TotalTickets}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                    <Label TextColor="{StaticResource TextTertiary}" FontSize="11">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Abertos: " TextColor="{StaticResource Warning}"/>
                                                <Span Text="{Binding TicketsAbertos}" TextColor="{StaticResource Warning}"/>
                                                <Span Text=" | Resolvidos: " TextColor="{StaticResource Success}"/>
                                                <Span Text="{Binding TicketsResolvidos}" TextColor="{StaticResource Success}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Ranking -->
                <HorizontalStackLayout Spacing="8" Margin="0,10,0,0">
                    <Image Source="icon_check.png" WidthRequest="16" HeightRequest="16" VerticalOptions="Center"/>
                    <Label Text="Top Usuários" TextColor="White" FontSize="14" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>
                <Label Text="{Binding Ranking.Count, StringFormat='Total: {0} usuários'}" TextColor="{StaticResource TextTertiary}" FontSize="12"/>

                <CollectionView ItemsSource="{Binding Ranking}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:RankingUsuarioDTO">
                            <Border BackgroundColor="{StaticResource BackgroundLight}"
                                    Padding="10"
                                    Margin="0,0,0,5"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0" Text="{Binding Nome}" TextColor="White" FontSize="12"/>
                                    <Label Grid.Column="1" Text="{Binding TotalTickets, StringFormat='{0} tickets'}" TextColor="{StaticResource Info}" FontSize="12" FontAttributes="Bold"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- Loading -->
            <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" Color="{StaticResource Primary}" Margin="0,20"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
