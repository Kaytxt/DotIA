<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:DotIA.Mobile.ViewModels"
             xmlns:models="clr-namespace:DotIA.Mobile.Models"
             x:Class="DotIA.Mobile.Views.GerentePage"
             x:DataType="viewmodels:GerenteViewModel"
             Title="Painel de Gerenciamento"
             BackgroundColor="{StaticResource Background}">

    <ScrollView>
        <VerticalStackLayout Spacing="15" Padding="15">

            <!-- Header -->
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,10" ColumnSpacing="12">
                <Border Grid.Column="0"
                        BackgroundColor="{StaticResource Primary}"
                        HeightRequest="40"
                        WidthRequest="40"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="20"/>
                    </Border.StrokeShape>
                    <Image Source="dotia_logo.png"
                           Margin="8"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Border>
                <Label Grid.Column="1"
                       Text="{Binding NomeUsuario, StringFormat='Ol치, {0}'}"
                       TextColor="White"
                       FontSize="20"
                       FontAttributes="Bold"
                       VerticalOptions="Center"/>
                <Button Grid.Column="2"
                        Text="Sair"
                        Command="{Binding SairCommand}"
                        BackgroundColor="#dc2626"
                        TextColor="White"/>
            </Grid>

            <!-- Cards de Estat칤sticas em Grid 2x3 -->
            <HorizontalStackLayout Spacing="8">
                <Image Source="icon_grafico.png" WidthRequest="20" HeightRequest="20" VerticalOptions="Center"/>
                <Label Text="Estat칤sticas" TextColor="White" FontSize="18" FontAttributes="Bold" VerticalOptions="Center"/>
            </HorizontalStackLayout>

            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="10">
                <!-- Card 1: Total Usu치rios -->
                <Border Grid.Row="0" Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="#ffffff30"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_pessoa.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TotalUsuarios}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Total Usu치rios" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 2: Tickets Abertos -->
                <Border Grid.Row="0" Grid.Column="1"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="#ffffff30"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_ticket.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TicketsAbertos}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Tickets Abertos" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 3: Resolvidos -->
                <Border Grid.Row="1" Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="#ffffff30"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_check.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TicketsResolvidos}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Resolvidos" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 4: Total Chats -->
                <Border Grid.Row="1" Grid.Column="1"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="#ffffff30"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_balao.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding TotalChats}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Total Chats" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 5: Hoje -->
                <Border Grid.Row="2" Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="#ffffff30"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_grafico.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding ResolvidosHoje}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Hoje" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>

                <!-- Card 6: Conclu칤dos -->
                <Border Grid.Row="2" Grid.Column="1"
                        BackgroundColor="{StaticResource BackgroundLight}"
                        Padding="15"
                        StrokeShape="RoundRectangle 15"
                        StrokeThickness="0">
                    <VerticalStackLayout Spacing="8">
                        <Border BackgroundColor="Transparent"
                                WidthRequest="55"
                                HeightRequest="55"
                                HorizontalOptions="Center"
                                Stroke="#ffffff30"
                                StrokeThickness="1"
                                Shadow="{Shadow Brush=Black, Offset='0,4', Radius=10, Opacity=0.3}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="28"/>
                            </Border.StrokeShape>
                            <Image Source="icon_balao.png" Margin="10"/>
                        </Border>
                        <Label Text="{Binding ChatsConcluidos}" TextColor="White" FontSize="26" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                        <Label Text="Conclu칤dos" TextColor="{StaticResource TextTertiary}" FontSize="12" HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <!-- Tabs -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="5" Margin="0,10,0,0">
                <Button Grid.Column="0"
                        Text="Tickets"
                        Command="{Binding MudarAbaCommand}"
                        CommandParameter="Tickets"
                        BackgroundColor="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=0}"
                        TextColor="White"/>
                <Button Grid.Column="1"
                        Text="Usu치rios"
                        Command="{Binding MudarAbaCommand}"
                        CommandParameter="Usuarios"
                        BackgroundColor="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=1}"
                        TextColor="White"/>
                <Button Grid.Column="2"
                        Text="Relat칩rios"
                        Command="{Binding MudarAbaCommand}"
                        CommandParameter="Relatorios"
                        BackgroundColor="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=2}"
                        TextColor="White"/>
            </Grid>

            <!-- ABA TICKETS -->
            <VerticalStackLayout IsVisible="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=0}" Spacing="5">
                <HorizontalStackLayout Spacing="8" Margin="0,10,0,5">
                    <Image Source="icon_ticket.png" WidthRequest="18" HeightRequest="18" VerticalOptions="Center"/>
                    <Label Text="Tickets" TextColor="White" FontSize="16" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>

                <Label Text="{Binding Tickets.Count, StringFormat='Total: {0} tickets'}" TextColor="#94a3b8" FontSize="12"/>

                <CollectionView ItemsSource="{Binding Tickets}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:TicketGerenteDTO">
                            <Frame BackgroundColor="#1e293b" Padding="10" Margin="0,0,0,5" CornerRadius="8">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding Id, StringFormat='ID: {0}'}" TextColor="#3b82f6" FontSize="12" FontAttributes="Bold"/>
                                    <Label Text="{Binding NomeSolicitante, StringFormat='Solicitante: {0}'}" TextColor="White" FontSize="13"/>
                                    <Label Text="{Binding Departamento, StringFormat='Depto: {0}'}" TextColor="#94a3b8" FontSize="11"/>
                                    <Label Text="{Binding DescricaoProblema}" TextColor="#cbd5e1" FontSize="12" MaxLines="2"/>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Grid.Column="0" Text="{Binding DataAbertura, StringFormat='{0:dd/MM/yy HH:mm}'}" TextColor="#64748b" FontSize="10"/>
                                        <Label Grid.Column="1" Text="{Binding Status}" TextColor="#10b981" FontSize="10"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- ABA USU츼RIOS -->
            <VerticalStackLayout IsVisible="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=1}" Spacing="5">
                <HorizontalStackLayout Spacing="8" Margin="0,10,0,5">
                    <Image Source="icon_pessoa.png" WidthRequest="18" HeightRequest="18" VerticalOptions="Center"/>
                    <Label Text="Usu치rios" TextColor="White" FontSize="16" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>

                <Label Text="{Binding Usuarios.Count, StringFormat='Total: {0} usu치rios'}" TextColor="#94a3b8" FontSize="12"/>

                <CollectionView ItemsSource="{Binding Usuarios}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:UsuarioGerenteDTO">
                            <Frame BackgroundColor="#1e293b" Padding="10" Margin="0,0,0,5" CornerRadius="8">
                                <VerticalStackLayout Spacing="5">
                                    <Label Text="{Binding Nome}" TextColor="White" FontSize="14" FontAttributes="Bold"/>
                                    <Label Text="{Binding Email}" TextColor="#94a3b8" FontSize="12"/>
                                    <Label Text="{Binding Departamento, StringFormat='Depto: {0}'}" TextColor="#3b82f6" FontSize="11"/>
                                    <Label TextColor="#94a3b8" FontSize="10">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Tickets: "/>
                                                <Span Text="{Binding TotalTickets}"/>
                                                <Span Text=" | Abertos: "/>
                                                <Span Text="{Binding TicketsAbertos}"/>
                                                <Span Text=" | Chats: "/>
                                                <Span Text="{Binding TotalChats}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <!-- Bot칫es de A칞칚o -->
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="5" RowSpacing="5" Margin="0,5,0,0">
                                        <Button Grid.Row="0" Grid.Column="0" Text="Editar" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=EditarUsuarioCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="#3b82f6"/>
                                        <Button Grid.Row="0" Grid.Column="1" Text="Cargo" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=AlterarCargoCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="#8b5cf6"/>
                                        <Button Grid.Row="1" Grid.Column="0" Text="Senha" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=AlterarSenhaCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="#fbbf24"/>
                                        <Button Grid.Row="1" Grid.Column="1" Text="Ver Tickets" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=VerTicketsUsuarioCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="#10b981"/>
                                        <Button Grid.Row="2" Grid.ColumnSpan="2" Text="Excluir Usu치rio" FontSize="10" Padding="5"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:GerenteViewModel}}, Path=ExcluirUsuarioCommand}"
                                                CommandParameter="{Binding .}" BackgroundColor="#ef4444"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- ABA RELAT칍RIOS -->
            <VerticalStackLayout IsVisible="{Binding AbaAtiva, Converter={StaticResource IntEqualsConverter}, ConverterParameter=2}" Spacing="10">
                <Label Text="游늵 Relat칩rios" TextColor="White" FontSize="16" FontAttributes="Bold" Margin="0,10,0,5"/>

                <!-- Por Departamento -->
                <Label Text="Por Departamento" TextColor="White" FontSize="14" FontAttributes="Bold"/>
                <Label Text="{Binding RelatoriosDepartamentos.Count, StringFormat='Total: {0} departamentos'}" TextColor="#94a3b8" FontSize="12"/>

                <CollectionView ItemsSource="{Binding RelatoriosDepartamentos}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:RelatorioDepartamentoDTO">
                            <Frame BackgroundColor="#1e293b" Padding="10" Margin="0,0,0,5" CornerRadius="8">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding Departamento}" TextColor="White" FontSize="13" FontAttributes="Bold"/>
                                    <Label TextColor="#94a3b8" FontSize="11">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Usu치rios: "/>
                                                <Span Text="{Binding TotalUsuarios}"/>
                                                <Span Text=" | Tickets: "/>
                                                <Span Text="{Binding TotalTickets}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                    <Label TextColor="#94a3b8" FontSize="11">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="Abertos: " TextColor="#fbbf24"/>
                                                <Span Text="{Binding TicketsAbertos}" TextColor="#fbbf24"/>
                                                <Span Text=" | Resolvidos: " TextColor="#10b981"/>
                                                <Span Text="{Binding TicketsResolvidos}" TextColor="#10b981"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Ranking -->
                <HorizontalStackLayout Spacing="8" Margin="0,10,0,0">
                    <Image Source="icon_check.png" WidthRequest="16" HeightRequest="16" VerticalOptions="Center"/>
                    <Label Text="Top Usu치rios" TextColor="White" FontSize="14" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>
                <Label Text="{Binding Ranking.Count, StringFormat='Total: {0} usu치rios'}" TextColor="#94a3b8" FontSize="12"/>

                <CollectionView ItemsSource="{Binding Ranking}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:RankingUsuarioDTO">
                            <Frame BackgroundColor="#1e293b" Padding="10" Margin="0,0,0,5" CornerRadius="8">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0" Text="{Binding Nome}" TextColor="White" FontSize="12"/>
                                    <Label Grid.Column="1" Text="{Binding TotalTickets, StringFormat='{0} tickets'}" TextColor="#3b82f6" FontSize="12" FontAttributes="Bold"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

            <!-- Loading -->
            <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" Color="#7c3aed" Margin="0,20"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
